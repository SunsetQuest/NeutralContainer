@page "/posts/{PostId:int}"

@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using NeutralContainer.Data
@inject ApplicationDbContext DbContext

@attribute [Authorize]

<PageTitle>Post</PageTitle>

<div class="container py-4">
    @if (isLoading)
    {
        <p class="text-muted">Loading post…</p>
    }
    else if (post is null)
    {
        <h1>Post not found</h1>
        <p class="text-muted">We could not find that post.</p>
    }
    else
    {
        <h1>@postTitle</h1>
        <div class="ratio ratio-16x9 mb-4">
            <iframe src="@($"https://www.youtube.com/embed/{post.YouTubeVideoId}")"
                    title="YouTube video"
                    allowfullscreen></iframe>
        </div>
        <p class="text-muted">
            Posted @post.CreatedAt.ToLocalTime().ToString("MMM d, yyyy")
        </p>
        @if (!string.IsNullOrWhiteSpace(post.ContextText))
        {
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="h5">Context</h2>
                    <p class="mb-0">@post.ContextText</p>
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public int PostId { get; set; }

    private Post? post;
    private bool isLoading = true;
    private string postTitle = "Untitled";

    protected override async Task OnParametersSetAsync()
    {
        isLoading = true;
        post = await DbContext.Posts
            .AsNoTracking()
            .FirstOrDefaultAsync(p => p.Id == PostId);
        postTitle = string.IsNullOrWhiteSpace(post?.Title) ? "Untitled" : post.Title;
        isLoading = false;
    }
}
