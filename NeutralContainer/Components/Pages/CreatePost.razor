@page "/posts/create"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using NeutralContainer.Data
@using NeutralContainer.Utilities
@inject ApplicationDbContext DbContext
@inject NavigationManager NavigationManager
@inject UserManager<ApplicationUser> UserManager

@attribute [Authorize]

<PageTitle>Create Post</PageTitle>

<div class="container py-4">
    <h1>Create Post</h1>
    <div class="alert alert-secondary" role="status">
        NeutralContainer is not crisis support. If you’re in immediate danger or need urgent help,
        contact local emergency services or a crisis line in your area.
        <details class="mt-2">
            <summary>Find crisis resources</summary>
            <p class="text-muted mb-2">
                Resources vary by region. If you are outside the areas listed, search for local crisis
                hotlines or emergency services in your country.
            </p>
            <ul class="mb-2">
                <li><strong>United States:</strong> <a href="https://988lifeline.org/" target="_blank" rel="noreferrer">988 Suicide &amp; Crisis Lifeline</a></li>
                <li><strong>United Kingdom &amp; Ireland:</strong> <a href="https://www.samaritans.org/" target="_blank" rel="noreferrer">Samaritans</a></li>
                <li><strong>Australia:</strong> <a href="https://www.lifeline.org.au/" target="_blank" rel="noreferrer">Lifeline</a></li>
                <li><strong>Global directory:</strong> <a href="https://www.iasp.info/resources/Crisis_Centres/" target="_blank" rel="noreferrer">International Association for Suicide Prevention</a></li>
            </ul>
            <p class="mb-0">If you need urgent help, contact local emergency services.</p>
        </details>
    </div>

    <EditForm EditContext="editContext" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <h2 class="h5">Post type</h2>
            <InputRadioGroup @bind-Value="SelectedPostType">
                <div class="form-check">
                    <InputRadio id="postTypeTextOnly" class="form-check-input" Value="PostType.TextOnly" />
                    <label class="form-check-label" for="postTypeTextOnly">Text-only</label>
                </div>
                <div class="form-check">
                    <InputRadio id="postTypeYouTube" class="form-check-input" Value="PostType.YouTubeBacked" />
                    <label class="form-check-label" for="postTypeYouTube">YouTube-backed</label>
                </div>
            </InputRadioGroup>
            @if (model.PostType == PostType.YouTubeBacked)
            {
                <p class="text-muted mt-2 mb-0">Use an Unlisted YouTube video; disable YouTube comments.</p>
            }
            else
            {
                <p class="text-muted mt-2 mb-0">This post will not include a video.</p>
            }
        </div>

        <div class="mb-3">
            <label class="form-label" for="title">Title (optional)</label>
            <InputText id="title"
                       class="form-control"
                       @bind-Value="model.Title" />
            <ValidationMessage For="@(() => model.Title)" />
        </div>

        <div class="mb-3">
            <label class="form-label" for="contextText">@GetBodyLabel()</label>
            <InputTextArea id="contextText"
                           class="form-control"
                           rows="4"
                           @bind-Value="model.ContextText" />
            <ValidationMessage For="@(() => model.ContextText)" />
        </div>

        @if (model.PostType == PostType.YouTubeBacked)
        {
            <div class="mb-3">
                <label class="form-label" for="youtubeUrl">YouTube URL</label>
                <InputText id="youtubeUrl"
                           class="form-control"
                           @bind-Value="model.YouTubeUrl"
                           @oninput="HandleUrlInput" />
                <ValidationMessage For="@(() => model.YouTubeUrl)" />
            </div>
        }

        <div class="mb-4">
            <h2 class="h5">Response Agreement</h2>
            <p class="text-muted mb-2">Select the tone and type of feedback you want to receive.</p>

            <div class="mb-3">
                <h3 class="h6">What I’m looking for</h3>
                <div class="form-check">
                    <InputCheckbox id="feedbackPresenceOnly" class="form-check-input" @bind-Value="model.FeedbackPresenceOnly" />
                    <label class="form-check-label" for="feedbackPresenceOnly">Presence-only (witnessing; “I hear you”)</label>
                </div>
                <div class="form-check">
                    <InputCheckbox id="feedbackReflectiveListening" class="form-check-input" @bind-Value="model.FeedbackReflectiveListening" />
                    <label class="form-check-label" for="feedbackReflectiveListening">Reflective listening (summarize what you heard)</label>
                </div>
                <div class="form-check">
                    <InputCheckbox id="feedbackClarifyingQuestions" class="form-check-input" @bind-Value="model.FeedbackClarifyingQuestions" />
                    <label class="form-check-label" for="feedbackClarifyingQuestions">Clarifying questions (gentle, no fixing)</label>
                </div>
                <div class="form-check">
                    <InputCheckbox id="feedbackSharePerspective" class="form-check-input" @bind-Value="model.FeedbackSharePerspective" />
                    <label class="form-check-label" for="feedbackSharePerspective">Share your perspective (non-prescriptive)</label>
                </div>
                <div class="form-check">
                    <InputCheckbox id="feedbackAdviceAllowed" class="form-check-input" @bind-Value="model.FeedbackAdviceAllowed" />
                    <label class="form-check-label" for="feedbackAdviceAllowed">Suggestions/advice allowed (explicit opt-in)</label>
                </div>
                <div class="form-check">
                    <InputCheckbox id="feedbackResourcesAllowed" class="form-check-input" @bind-Value="model.FeedbackResourcesAllowed" />
                    <label class="form-check-label" for="feedbackResourcesAllowed">Resources allowed (explicit opt-in)</label>
                </div>
                <ValidationMessage For="@(() => model.FeedbackPresenceOnly)" />
            </div>

            <div class="mb-3">
                <h3 class="h6">Please avoid</h3>
                <div class="form-check">
                    <InputCheckbox id="avoidDiagnosing" class="form-check-input" @bind-Value="model.AvoidDiagnosingOrLabeling" />
                    <label class="form-check-label" for="avoidDiagnosing">Diagnosing or labeling</label>
                </div>
                <div class="form-check">
                    <InputCheckbox id="avoidMoralizing" class="form-check-input" @bind-Value="model.AvoidMoralizingOrShaming" />
                    <label class="form-check-label" for="avoidMoralizing">Moralizing or shaming</label>
                </div>
                <div class="form-check">
                    <InputCheckbox id="avoidPrescriptive" class="form-check-input" @bind-Value="model.AvoidPrescriptiveLanguage" />
                    <label class="form-check-label" for="avoidPrescriptive">Prescriptive language if advice not allowed</label>
                </div>
                <div class="form-check">
                    <InputCheckbox id="avoidMinimizing" class="form-check-input" @bind-Value="model.AvoidMinimizingOrDismissing" />
                    <label class="form-check-label" for="avoidMinimizing">Minimizing or dismissing</label>
                </div>
                <div class="form-check">
                    <InputCheckbox id="avoidResolution" class="form-check-input" @bind-Value="model.AvoidPushingTowardResolution" />
                    <label class="form-check-label" for="avoidResolution">Pushing toward resolution if presence-only</label>
                </div>
            </div>

            <div class="mb-3">
                <h3 class="h6">Sensitivity toggles</h3>
                <div class="form-check">
                    <InputCheckbox id="sensitivityExtraGentle" class="form-check-input" @bind-Value="model.SensitivityExtraGentleContainer" />
                    <label class="form-check-label" for="sensitivityExtraGentle">Extra gentle container</label>
                </div>
                <div class="form-check">
                    <InputCheckbox id="sensitivityNoMentalHealthLabels" class="form-check-input" @bind-Value="model.SensitivityNoMentalHealthLabels" />
                    <label class="form-check-label" for="sensitivityNoMentalHealthLabels">No mental health labels</label>
                </div>
                <div class="form-check">
                    <InputCheckbox id="sensitivityNoRelationshipAdvice" class="form-check-input" @bind-Value="model.SensitivityNoRelationshipAdvice" />
                    <label class="form-check-label" for="sensitivityNoRelationshipAdvice">No relationship advice</label>
                </div>
                <div class="form-check">
                    <InputCheckbox id="sensitivityNoMedicalAdvice" class="form-check-input" @bind-Value="model.SensitivityNoMedicalAdvice" />
                    <label class="form-check-label" for="sensitivityNoMedicalAdvice">No medical advice</label>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label" for="customRulesText">Custom rules (optional)</label>
                <InputTextArea id="customRulesText"
                               class="form-control"
                               rows="3"
                               @bind-Value="model.CustomRulesText" />
                <ValidationMessage For="@(() => model.CustomRulesText)" />
            </div>
        </div>

        <div class="mb-4">
            <h2 class="h5">Comment visibility policy</h2>
            <InputRadioGroup @bind-Value="model.VisibilityPolicy">
                <div class="form-check">
                    <InputRadio id="visibilityPrivateOnly" class="form-check-input" Value="VisibilityPolicy.PrivateOnly" />
                    <label class="form-check-label" for="visibilityPrivateOnly">Private only</label>
                </div>
                <div class="form-check">
                    <InputRadio id="visibilityPublicOnly" class="form-check-input" Value="VisibilityPolicy.PublicOnly" />
                    <label class="form-check-label" for="visibilityPublicOnly">Public only</label>
                </div>
                <div class="form-check">
                    <InputRadio id="visibilityCommenterChoice" class="form-check-input" Value="VisibilityPolicy.CommenterChoice" />
                    <label class="form-check-label" for="visibilityCommenterChoice">Commenter chooses</label>
                </div>
            </InputRadioGroup>
            <p class="text-muted mt-2 mb-0">Public visibility requires explicit commenter consent.</p>
            <ValidationMessage For="@(() => model.VisibilityPolicy)" />
        </div>

        <div class="mb-4">
            <h2 class="h5">Moderation strictness</h2>
            <InputRadioGroup @bind-Value="model.ModerationLevel">
                <div class="form-check">
                    <InputRadio id="moderationStandard" class="form-check-input" Value="ModerationLevel.Standard" />
                    <label class="form-check-label" for="moderationStandard">Standard</label>
                </div>
                <div class="form-check">
                    <InputRadio id="moderationHigh" class="form-check-input" Value="ModerationLevel.High" />
                    <label class="form-check-label" for="moderationHigh">High (extra gentle)</label>
                </div>
            </InputRadioGroup>
            <ValidationMessage For="@(() => model.ModerationLevel)" />
        </div>

        @if (model.PostType == PostType.YouTubeBacked && !string.IsNullOrWhiteSpace(model.VideoId))
        {
            <div class="mb-4">
                <label class="form-label">Preview</label>
                <div class="ratio ratio-16x9">
                    <iframe src="@($"https://www.youtube.com/embed/{model.VideoId}")"
                            title="YouTube video preview"
                            allowfullscreen></iframe>
                </div>
            </div>
        }

        @if (!string.IsNullOrWhiteSpace(saveError))
        {
            <div class="alert alert-danger">@saveError</div>
        }

        <button class="btn btn-primary" type="submit">Publish</button>
    </EditForm>
</div>

@code {
    private readonly CreatePostModel model = new();
    private EditContext? editContext;
    private string? saveError;

    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    protected override void OnInitialized()
    {
        editContext = new EditContext(model);
    }

    private PostType SelectedPostType
    {
        get => model.PostType;
        set
        {
            if (model.PostType == value)
            {
                return;
            }

            model.PostType = value;
            if (model.PostType == PostType.TextOnly)
            {
                model.YouTubeUrl = string.Empty;
                model.VideoId = null;
            }

            saveError = null;
            editContext?.NotifyValidationStateChanged();
        }
    }

    private void HandleUrlInput(ChangeEventArgs args)
    {
        model.YouTubeUrl = args.Value?.ToString() ?? string.Empty;
        if (YouTubeUrlHelper.TryExtractVideoId(model.YouTubeUrl, out var videoId))
        {
            model.VideoId = videoId;
        }
        else
        {
            model.VideoId = null;
        }

        editContext?.NotifyValidationStateChanged();
    }

    private async Task HandleValidSubmit()
    {
        saveError = null;

        if (editContext is null)
        {
            saveError = "Unable to validate the form. Please refresh and try again.";
            return;
        }

        string? videoId = null;
        if (model.PostType == PostType.YouTubeBacked)
        {
            if (!YouTubeUrlHelper.TryExtractVideoId(model.YouTubeUrl, out videoId))
            {
                saveError = "Please enter a valid YouTube URL.";
                return;
            }
        }

        var authState = await AuthenticationStateTask;
        var user = await UserManager.GetUserAsync(authState.User);
        if (user is null)
        {
            saveError = "Unable to identify the current user. Please sign in again.";
            return;
        }

        var post = new Post
        {
            CreatorUserId = user.Id,
            PostType = model.PostType,
            YouTubeUrl = model.PostType == PostType.YouTubeBacked ? model.YouTubeUrl?.Trim() : null,
            YouTubeVideoId = model.PostType == PostType.YouTubeBacked ? videoId : null,
            Title = string.IsNullOrWhiteSpace(model.Title) ? null : model.Title.Trim(),
            ContextText = string.IsNullOrWhiteSpace(model.ContextText) ? null : model.ContextText.Trim(),
            AllowedFeedbackModes = model.BuildAllowedFeedbackModes(),
            AvoidanceModes = model.BuildAvoidanceModes(),
            SensitivityFlags = model.BuildSensitivityFlags(),
            CustomRulesText = string.IsNullOrWhiteSpace(model.CustomRulesText) ? null : model.CustomRulesText.Trim(),
            VisibilityPolicy = model.VisibilityPolicy,
            ModerationLevel = model.ModerationLevel
        };

        DbContext.Posts.Add(post);
        await DbContext.SaveChangesAsync();

        NavigationManager.NavigateTo($"/posts/{post.Id}");
    }

    private sealed class CreatePostModel : IValidatableObject
    {
        [Required]
        public PostType PostType { get; set; } = PostType.YouTubeBacked;

        public string? YouTubeUrl { get; set; }

        public string? VideoId { get; set; }

        [MaxLength(200)]
        public string? Title { get; set; }

        [MaxLength(2000)]
        public string? ContextText { get; set; }

        public bool FeedbackPresenceOnly { get; set; }

        public bool FeedbackReflectiveListening { get; set; }

        public bool FeedbackClarifyingQuestions { get; set; }

        public bool FeedbackSharePerspective { get; set; }

        public bool FeedbackAdviceAllowed { get; set; }

        public bool FeedbackResourcesAllowed { get; set; }

        public bool AvoidDiagnosingOrLabeling { get; set; }

        public bool AvoidMoralizingOrShaming { get; set; }

        public bool AvoidPrescriptiveLanguage { get; set; }

        public bool AvoidMinimizingOrDismissing { get; set; }

        public bool AvoidPushingTowardResolution { get; set; }

        public bool SensitivityExtraGentleContainer { get; set; }

        public bool SensitivityNoMentalHealthLabels { get; set; }

        public bool SensitivityNoRelationshipAdvice { get; set; }

        public bool SensitivityNoMedicalAdvice { get; set; }

        [MaxLength(2000)]
        public string? CustomRulesText { get; set; }

        [Required]
        public VisibilityPolicy VisibilityPolicy { get; set; } = VisibilityPolicy.PrivateOnly;

        [Required]
        public ModerationLevel ModerationLevel { get; set; } = ModerationLevel.Standard;

        public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
        {
            if (PostType == PostType.YouTubeBacked)
            {
                if (string.IsNullOrWhiteSpace(YouTubeUrl))
                {
                    yield return new ValidationResult(
                        "Enter a YouTube URL for a YouTube-backed post.",
                        new[] { nameof(YouTubeUrl) });
                }
                else if (!YouTubeUrlHelper.TryExtractVideoId(YouTubeUrl, out _))
                {
                    yield return new ValidationResult(
                        "Enter a valid YouTube URL (youtu.be or youtube.com).",
                        new[] { nameof(YouTubeUrl) });
                }
            }

            if (!FeedbackPresenceOnly
                && !FeedbackReflectiveListening
                && !FeedbackClarifyingQuestions
                && !FeedbackSharePerspective
                && !FeedbackAdviceAllowed
                && !FeedbackResourcesAllowed)
            {
                yield return new ValidationResult(
                    "Select at least one feedback mode you are open to receiving.",
                    new[] { nameof(FeedbackPresenceOnly) });
            }
        }

        public FeedbackMode BuildAllowedFeedbackModes()
        {
            var modes = FeedbackMode.None;
            if (FeedbackPresenceOnly)
            {
                modes |= FeedbackMode.PresenceOnly;
            }

            if (FeedbackReflectiveListening)
            {
                modes |= FeedbackMode.ReflectiveListening;
            }

            if (FeedbackClarifyingQuestions)
            {
                modes |= FeedbackMode.ClarifyingQuestions;
            }

            if (FeedbackSharePerspective)
            {
                modes |= FeedbackMode.SharePerspective;
            }

            if (FeedbackAdviceAllowed)
            {
                modes |= FeedbackMode.AdviceAllowed;
            }

            if (FeedbackResourcesAllowed)
            {
                modes |= FeedbackMode.ResourcesAllowed;
            }

            return modes;
        }

        public AvoidanceMode BuildAvoidanceModes()
        {
            var modes = AvoidanceMode.None;
            if (AvoidDiagnosingOrLabeling)
            {
                modes |= AvoidanceMode.DiagnosingOrLabeling;
            }

            if (AvoidMoralizingOrShaming)
            {
                modes |= AvoidanceMode.MoralizingOrShaming;
            }

            if (AvoidPrescriptiveLanguage)
            {
                modes |= AvoidanceMode.PrescriptiveLanguage;
            }

            if (AvoidMinimizingOrDismissing)
            {
                modes |= AvoidanceMode.MinimizingOrDismissing;
            }

            if (AvoidPushingTowardResolution)
            {
                modes |= AvoidanceMode.PushingTowardResolution;
            }

            return modes;
        }

        public SensitivityFlag BuildSensitivityFlags()
        {
            var flags = SensitivityFlag.None;
            if (SensitivityExtraGentleContainer)
            {
                flags |= SensitivityFlag.ExtraGentleContainer;
            }

            if (SensitivityNoMentalHealthLabels)
            {
                flags |= SensitivityFlag.NoMentalHealthLabels;
            }

            if (SensitivityNoRelationshipAdvice)
            {
                flags |= SensitivityFlag.NoRelationshipAdvice;
            }

            if (SensitivityNoMedicalAdvice)
            {
                flags |= SensitivityFlag.NoMedicalAdvice;
            }

            return flags;
        }
    }

    private string GetBodyLabel() => model.PostType == PostType.TextOnly
        ? "Body (optional)"
        : "Context (optional)";
}
